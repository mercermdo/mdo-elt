name: Hourly HubSpot ELT to BigQuery

on:
  schedule:
    - cron: '0 * * * *'  # Every hour, on the hour
  workflow_dispatch:      # Allow manual trigger too

jobs:
  run-etl:
    runs-on: ubuntu-latest
    env:
      HUBSPOT_TOKEN: ${{ secrets.HUBSPOT_TOKEN }}
      BQ_PROJECT_ID: ${{ secrets.BQ_PROJECT_ID }}
      BQ_DATASET:    ${{ secrets.BQ_DATASET }}
      BQ_TABLE:      ${{ secrets.BQ_TABLE }}

    steps:
    - name: ‚¨áÔ∏è Checkout code
      uses: actions/checkout@v3

    - name: üü¢ Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: üì¶ Install dependencies
      run: npm install

    - name: üîê Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_KEY }}

    - name: üêõ Echo env
      run: |
        echo "Project ‚ûú  $BQ_PROJECT_ID"
        echo "Dataset ‚ûú  $BQ_DATASET"
        echo "Table   ‚ûú  $BQ_TABLE"
      env:
        BQ_PROJECT_ID: ${{ secrets.BQ_PROJECT_ID }}
        BQ_DATASET:    ${{ secrets.BQ_DATASET }}         # ‚Üê the same literal you pass below
        BQ_TABLE:      ${{ secrets.BQ_TABLE }}


    - name: üöÄ Run ELT script
      env:
        HUBSPOT_TOKEN: ${{ secrets.HUBSPOT_TOKEN }}
        BQ_PROJECT_ID: ${{ secrets.BQ_PROJECT_ID }}
        BQ_DATASET: ${{ secrets.BQ_DATASET }}
        BQ_TABLE: ${{ secrets.BQ_TABLE }}
      run: node index.js
